<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ IA Life Simulator - Inteligencia Artificial Real</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            max-width: 1400px;
            width: 100%;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .main-content {
            display: flex;
            gap: 20px;
            padding: 20px;
        }

        .canvas-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        canvas {
            border: 2px solid #333;
            border-radius: 10px;
            background: rgba(135, 206, 235, 0.2);
            cursor: crosshair;
        }

        .controls {
            flex: 0 0 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .panel {
            background: #f5f5f5;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #667eea;
        }

        .panel h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 14px;
            text-transform: uppercase;
        }

        .control-group {
            margin-bottom: 12px;
        }

        .control-group label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .control-group input[type="color"],
        .control-group select,
        .control-group button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 12px;
        }

        select {
            cursor: pointer;
        }

        button {
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #FF6B6B;
            color: white;
        }

        .btn-tertiary {
            background: #4CAF50;
            color: white;
        }

        .map-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .map-buttons button {
            padding: 6px;
            font-size: 11px;
        }

        .item-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .item-buttons button {
            padding: 8px;
            font-size: 12px;
            background: #e0e0e0;
            color: #333;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            margin-bottom: 8px;
        }

        .stat-label {
            color: #666;
            font-weight: 600;
        }

        .stat-value {
            color: #333;
            font-weight: 700;
            font-size: 14px;
        }

        .energy-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%);
            transition: width 0.3s;
            border-radius: 10px;
        }

        .mood {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .mood-dying { background: #ffebee; color: #c62828; }
        .mood-tired { background: #fff3e0; color: #e65100; }
        .mood-neutral { background: #e3f2fd; color: #1976d2; }
        .mood-happy { background: #f1f8e9; color: #33691e; }

        .instructions {
            font-size: 11px;
            color: #666;
            line-height: 1.6;
        }

        .instructions strong {
            color: #333;
        }

        .toggle-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .toggle {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
        }

        .toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #667eea;
        }

        input:checked + .slider:before {
            transform: translateX(16px);
        }

        .debug-info {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 8px;
            font-size: 11px;
            font-family: monospace;
            color: #333;
            max-height: 150px;
            overflow-y: auto;
        }

        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }

            .controls {
                flex: none;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Simulador de Vida Artificial - Q-Learning Real</h1>
            <p>Observa c√≥mo una IA aprende y se adapta en tiempo real</p>
        </div>

        <div class="main-content">
            <div class="canvas-section">
                <canvas id="gameCanvas"></canvas>
                <div style="font-size: 12px; color: #666;">
                    <strong>Click Izq:</strong> Comida | <strong>Click Der:</strong> Bloque | <strong>Rueda:</strong> Cambiar tipo
                </div>
            </div>

            <div class="controls">
                <!-- OBJETIVO -->
                <div class="panel">
                    <h3>üéØ Objetivo del Agente</h3>
                    <div class="control-group">
                        <label for="objective">¬øQu√© debe aprender?</label>
                        <select id="objective" onchange="changeObjective(this.value)">
                            <option value="food">üçé Buscar Comida</option>
                            <option value="milk">ü•õ Beber Leche</option>
                            <option value="flag">üö© Alcanzar Bandera</option>
                            <option value="no_jump">üö´ No Saltar</option>
                        </select>
                    </div>
                </div>

                <!-- COLOCADORES DE ITEMS -->
                <div class="panel">
                    <h3>üõ†Ô∏è Crear Items</h3>
                    <div class="item-buttons">
                        <button class="btn-secondary" onclick="setPlacementMode('food')">üçé Comida</button>
                        <button class="btn-secondary" onclick="setPlacementMode('milk')">ü•õ Leche</button>
                        <button class="btn-secondary" onclick="setPlacementMode('spike')">‚ö†Ô∏è Pincho</button>
                        <button class="btn-secondary" onclick="setPlacementMode('block')">üß± Bloque</button>
                        <button class="btn-secondary" onclick="setPlacementMode('flag')">üö© Bandera</button>
                        <button class="btn-tertiary" onclick="clearAll()">üóëÔ∏è Limpiar</button>
                    </div>
                </div>

                <!-- MAPAS PREDEFINIDOS -->
                <div class="panel">
                    <h3>üó∫Ô∏è Mapas</h3>
                    <div class="map-buttons">
                        <button onclick="loadMap('empty')" class="btn-tertiary">Vac√≠o</button>
                        <button onclick="loadMap('simple')" class="btn-tertiary">Simple</button>
                        <button onclick="loadMap('obstacle')" class="btn-tertiary">Obst√°culos</button>
                        <button onclick="loadMap('maze')" class="btn-tertiary">Laberinto</button>
                    </div>
                </div>

                <!-- CONFIGURACI√ìN -->
                <div class="panel">
                    <h3>‚öôÔ∏è Configuraci√≥n</h3>
                    <div class="control-group">
                        <label for="agentColor">Color del Agente</label>
                        <input type="color" id="agentColor" value="#FF6B6B" onchange="agent.color = this.value;">
                    </div>
                    <div class="control-group">
                        <label>
                            <div class="toggle-row">
                                <span>Castigo por Saltar</span>
                                <label class="toggle">
                                    <input type="checkbox" id="jumpPenalty" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </label>
                    </div>
                    <button class="btn-primary" onclick="resetSimulation()">üîÑ Reset Completo</button>
                </div>

                <!-- ESTAD√çSTICAS -->
                <div class="panel">
                    <h3>üìä Estad√≠sticas</h3>
                    <div class="stat-item">
                        <span class="stat-label">Estado:</span>
                        <span class="mood mood-neutral" id="moodDisplay">üòê Neutral</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Energ√≠a:</span>
                        <span class="stat-value" id="energyDisplay">100%</span>
                    </div>
                    <div class="energy-bar">
                        <div class="energy-fill" id="energyBar" style="width: 100%"></div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Comida: <span id="foodCount">0</span></span>
                        <span class="stat-label">Leche: <span id="milkCount">0</span></span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Banderas: <span id="flagCount">0</span></span>
                        <span class="stat-label">Saltos: <span id="jumpCount">0</span></span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Experiencia: <span id="experienceCount">0</span></span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Aprendizaje:</span>
                        <span class="stat-value" id="epsilonDisplay">50%</span>
                    </div>
                </div>

                <!-- DEBUG -->
                <div class="panel">
                    <h3>üîç Debug</h3>
                    <div class="debug-info" id="debugInfo">
                        Iniciando...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- M√ìDULOS -->
    <script src="js/brain/CognitiveSystem.js"></script>
    <script src="js/learning/LearningSystem.js"></script>
    <script src="js/physics/PhysicsEngine.js"></script>
    <script src="js/core/Entities.js"></script>

    <script>
        // ==========================================
        // CONFIGURACI√ìN INICIAL
        // ==========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = 800;
        canvas.height = 500;
        const GROUND_HEIGHT = 50;
        
        let agent;
        let foods = [];
        let blocks = [];
        let spikes = [];
        let milks = [];
        let flags = [];
        let frameCount = 0;
        let placementMode = 'food';
        let lastScrollType = 'food';

        // ==========================================
        // INICIALIZACI√ìN
        // ==========================================
        function initAgent() {
            try {
                const objective = document.getElementById('objective').value || 'food';
                agent = new Agent(canvas, objective);
                agent.color = document.getElementById('agentColor').value;
                console.log('‚úì Agente creado con objetivo:', objective);
            } catch(e) {
                console.error('Error:', e);
            }
        }

        // ==========================================
        // FUNCIONES DE CONTROL
        // ==========================================
        function changeObjective(value) {
            if (agent) {
                agent.objective = value;
                agent.learning.epsilon = 0.5;
                console.log('Objetivo cambi√≥ a:', value);
            }
        }

        function setPlacementMode(mode) {
            placementMode = mode;
            lastScrollType = mode;
            console.log('Modo:', mode);
        }

        function loadMap(mapName) {
            clearAll();
            
            if (mapName === 'simple') {
                foods.push(new Food(650, 350));
                blocks.push(new Block(400, 350));
            } else if (mapName === 'obstacle') {
                foods.push(new Food(700, 300));
                blocks.push(new Block(250, 350));
                blocks.push(new Block(500, 350));
                spikes.push(new Spike(350, 400));
            } else if (mapName === 'maze') {
                foods.push(new Food(700, 300));
                for (let x = 200; x < 700; x += 100) {
                    blocks.push(new Block(x, 350));
                }
                flags.push(new Flag(750, 300));
            }
        }

        function clearAll() {
            foods = [];
            blocks = [];
            spikes = [];
            milks = [];
            flags = [];
        }

        function resetSimulation() {
            initAgent();
            clearAll();
            frameCount = 0;
            console.log('Simulaci√≥n reiniciada');
        }

        function updateUI() {
            const energyPercent = Math.round((agent.energy / agent.maxEnergy) * 100);
            document.getElementById('energyDisplay').textContent = energyPercent + '%';
            document.getElementById('energyBar').style.width = energyPercent + '%';

            const energyBar = document.getElementById('energyBar');
            if (energyPercent > 60) {
                energyBar.style.background = 'linear-gradient(90deg, #4CAF50 0%, #8BC34A 100%)';
            } else if (energyPercent > 30) {
                energyBar.style.background = 'linear-gradient(90deg, #FFC107 0%, #FF9800 100%)';
            } else {
                energyBar.style.background = 'linear-gradient(90deg, #FF6B6B 0%, #FF3838 100%)';
            }

            const moodEmojis = {
                'dying': 'üíÄ',
                'tired': 'üò¥',
                'neutral': 'üòê',
                'happy': 'üòä'
            };

            const moodDisplay = document.getElementById('moodDisplay');
            moodDisplay.textContent = moodEmojis[agent.mood] + ' ' + agent.mood.charAt(0).toUpperCase() + agent.mood.slice(1);
            moodDisplay.className = 'mood mood-' + agent.mood;

            document.getElementById('foodCount').textContent = agent.foodEaten;
            document.getElementById('milkCount').textContent = agent.milkDrunk;
            document.getElementById('flagCount').textContent = agent.flagsReached;
            document.getElementById('jumpCount').textContent = agent.jumpCount;
            document.getElementById('experienceCount').textContent = agent.learning.stats.totalExperiences;
            document.getElementById('epsilonDisplay').textContent = Math.round((1 - agent.learning.epsilon) * 100) + '%';

            // Debug info
            const debugInfo = document.getElementById('debugInfo');
            const mentalStatus = agent.brain.getMentalStatus();
            const stats = agent.learning.getStats();
            debugInfo.innerHTML = `
                <strong>Visi√≥n:</strong> ${mentalStatus.vision || 'Buscando...'}<br>
                <strong>Objetivo:</strong> ${agent.objective}<br>
                <strong>Costo Salto:</strong> ${mentalStatus.jumpCost}<br>
                <strong>Estados:</strong> ${stats.states}<br>
                <strong>Aprendizaje:</strong> ${(100 - stats.epsilon * 100).toFixed(1)}%<br>
                <strong>Objetivos:</strong> ${stats.objectives}
            `;
        }

        function drawGround() {
            ctx.fillStyle = '#7CB342';
            ctx.fillRect(0, canvas.height - GROUND_HEIGHT, canvas.width, GROUND_HEIGHT);

            ctx.strokeStyle = '#558B2F';
            ctx.lineWidth = 2;
            for (let i = 0; i < canvas.width; i += 10) {
                ctx.beginPath();
                ctx.moveTo(i, canvas.height - GROUND_HEIGHT);
                ctx.lineTo(i + 3, canvas.height - GROUND_HEIGHT - 5);
                ctx.stroke();
            }
        }

        function gameLoop() {
            try {
                frameCount++;

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'rgba(135, 206, 235, 0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height - GROUND_HEIGHT);
                
                drawGround();

                foods.forEach(food => { food.update(); food.draw(ctx); });
                milks.forEach(milk => { milk.update(); milk.draw(ctx); });
                blocks.forEach(block => block.draw(ctx));
                spikes.forEach(spike => spike.draw(ctx));
                flags.forEach(flag => { flag.update(); flag.draw(ctx); });

                const jumpPenalty = document.getElementById('jumpPenalty').checked;
                agent.update(foods, blocks, spikes, milks, flags, jumpPenalty);
                agent.draw(ctx);

                updateUI();

                requestAnimationFrame(gameLoop);
            } catch(e) {
                console.error('Error en gameLoop:', e.message);
            }
        }

        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (placementMode === 'food') foods.push(new Food(x, y));
            else if (placementMode === 'milk') milks.push(new Milk(x, y));
            else if (placementMode === 'spike') spikes.push(new Spike(x, y));
            else if (placementMode === 'block') blocks.push(new Block(x - 20, y - 20));
            else if (placementMode === 'flag') flags.push(new Flag(x, y));
        });

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const types = ['food', 'milk', 'spike', 'block', 'flag'];
            const currentIndex = types.indexOf(lastScrollType);
            const newIndex = (currentIndex + (e.deltaY > 0 ? 1 : -1)) % types.length;
            setPlacementMode(types[newIndex < 0 ? types.length - 1 : newIndex]);
        });

        // ==========================================
        // INICIAR
        // ==========================================
        initAgent();
        loadMap('simple');
        gameLoop();
    </script>
</body>
</html>
